{% extends "layout.html" %}

{% block title %}Vulnerability Scanner - ThreatGuard{% endblock %}

{% block additional_css %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
{% endblock %}

{% block user_actions %}
<a href="/scan" class="scan-btn"><i class="fas fa-search"></i> New Scan</a>
<a href="/rescan" class="rescan-btn"><i class="fas fa-sync-alt"></i> Rescan</a>
{% endblock %}

{% block content %}
<div class="dashboard-summary">
    <div class="summary-card total">
        <div class="summary-icon"><i class="fas fa-bug"></i></div>
        <div class="summary-info">
            <h3>Total Vulnerabilities</h3>
            <p id="total-vulns">Loading...</p>
        </div>
    </div>
    <div class="summary-card critical">
        <div class="summary-icon"><i class="fas fa-radiation-alt"></i></div>
        <div class="summary-info">
            <h3>Critical</h3>
            <p id="critical-vulns">Loading...</p>
        </div>
    </div>
    <div class="summary-card high">
        <div class="summary-icon"><i class="fas fa-exclamation-circle"></i></div>
        <div class="summary-info">
            <h3>High</h3>
            <p id="high-vulns">Loading...</p>
        </div>
    </div>
    <div class="summary-card status">
        <div class="summary-icon"><i class="fas fa-hourglass-half"></i></div>
        <div class="summary-info">
            <h3>Scan Status</h3>
            <p id="scan-status">None</p>
        </div>
    </div>
</div>

<div class="scan-details">
    <div class="scan-target">
        <strong>Target:</strong> <span id="scan-target">None</span>
    </div>
    <div class="scan-timestamp">
        <strong>Last Scan:</strong> <span id="scan-timestamp">None</span>
    </div>
</div>

<div class="vulnerability-chart-container">
    <div class="chart-container">
        <div class="chart-header">
            <h3>Vulnerability Severity Distribution</h3>
        </div>
        <canvas id="vuln-distribution-chart"></canvas>
    </div>
</div>

<div class="threat-table-container">
    <div class="table-header">
        <h3>Detected Vulnerabilities</h3>
        <div class="table-actions">
            <button><i class="fas fa-filter"></i> Filter</button>
            <button><i class="fas fa-download"></i> Export</button>
        </div>
    </div>
    <div class="table-wrapper">
        <table class="threat-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Host</th>
                    <th>Port</th>
                    <th>Severity</th>
                    <th>CVSS</th>
                    <th>Timestamp</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="vulnerability-table-body">
                <tr>
                    <td colspan="8" class="loading-cell">No vulnerability data available...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // DOM Elements
    const lastUpdated = document.getElementById('last-updated');
    const totalVulns = document.getElementById('total-vulns');
    const criticalVulns = document.getElementById('critical-vulns');
    const highVulns = document.getElementById('high-vulns');
    const scanStatus = document.getElementById('scan-status');
    const scanTarget = document.getElementById('scan-target');
    const scanTimestamp = document.getElementById('scan-timestamp');
    const vulnTableBody = document.getElementById('vulnerability-table-body');
    const refreshBtn = document.querySelector('.refresh-btn');

    // Chart
    let distributionChart;

    // Close flash messages
    document.querySelectorAll('.close-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            this.parentElement.remove();
        });
    });

    // Update timestamp
    function updateTimestamp() {
        const now = new Date();
        lastUpdated.textContent = now.toLocaleString();
    }

    // Fetch vulnerability data
    async function fetchVulnerabilities() {
        try {
            const response = await fetch('/api/vulnerabilities');
            const data = await response.json();
            renderVulnerabilityTable(data.results);
            updateSummary(data);
            updateDistributionChart(data.summary);
        } catch (error) {
            console.error('Error fetching vulnerabilities:', error);
        }
    }

    // Update summary display
    function updateSummary(data) {
        totalVulns.textContent = data.total || 0;
        criticalVulns.textContent = data.summary.Critical || 0;
        highVulns.textContent = data.summary.High || 0;
        scanStatus.textContent = data.status || 'None';
        scanTarget.textContent = data.target || 'None';
        scanTimestamp.textContent = data.last_scan || 'None';
        
        // Highlight scan status
        scanStatus.className = '';
        if (data.status === 'Running') {
            scanStatus.classList.add('status-running');
        } else if (data.status === 'Completed') {
            scanStatus.classList.add('status-completed');
        } else if (data.status && data.status.startsWith('Error')) {
            scanStatus.classList.add('status-error');
        }
    }

    // Render vulnerability table
    function renderVulnerabilityTable(vulnerabilities) {
        vulnTableBody.innerHTML = '';
        
        if (!vulnerabilities || vulnerabilities.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="8" class="loading-cell">No vulnerability data available...</td>';
            vulnTableBody.appendChild(row);
            return;
        }
        
        vulnerabilities.forEach(vuln => {
            const row = document.createElement('tr');
            
            const severityClass = getSeverityClass(vuln.severity);
            
            row.innerHTML = `
                <td>${vuln.id || 'N/A'}</td>
                <td>${vuln.name}</td>
                <td>${vuln.host}</td>
                <td>${vuln.port}</td>
                <td><span class="threat-severity ${severityClass}">${vuln.severity}</span></td>
                <td>${vuln.cvss_base}</td>
                <td>${vuln.timestamp}</td>
                <td class="threat-actions">
                    <button title="View Details"><i class="fas fa-eye"></i></button>
                    <button title="Remediate"><i class="fas fa-wrench"></i></button>
                    <button title="Ignore"><i class="fas fa-ban"></i></button>
                </td>
            `;
            
            vulnTableBody.appendChild(row);
        });
    }

    // Get severity class
    function getSeverityClass(severity) {
        switch (severity.toLowerCase()) {
            case 'critical':
                return 'severity-critical';
            case 'high':
                return 'severity-high';
            case 'medium':
                return 'severity-medium';
            case 'low':
                return 'severity-low';
            default:
                return '';
        }
    }

    // Initialize distribution chart
    function initDistributionChart() {
        const ctx = document.getElementById('vuln-distribution-chart').getContext('2d');
        
        // Chart.js global settings for dark theme
        Chart.defaults.color = '#a9b7d0';
        Chart.defaults.borderColor = '#2a3042';
        
        distributionChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Critical', 'High', 'Medium', 'Low'],
                datasets: [{
                    data: [0, 0, 0, 0],
                    backgroundColor: [
                        '#ff3b30',  // Critical - Red
                        '#ff9500',  // High - Orange
                        '#ffcc00',  // Medium - Yellow
                        '#34c759'   // Low - Green
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            boxWidth: 12,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1e2736',
                        titleColor: '#ffffff',
                        bodyColor: '#e0e0e0',
                        borderColor: '#2a3042',
                        borderWidth: 1
                    }
                }
            }
        });
    }

    // Update distribution chart
    function updateDistributionChart(summary) {
        if (!distributionChart) return;
        
        distributionChart.data.datasets[0].data = [
            summary.Critical || 0,
            summary.High || 0,
            summary.Medium || 0,
            summary.Low || 0
        ];
        
        distributionChart.update();
    }

    // Refresh all data
    function refreshData() {
        fetchVulnerabilities();
        updateTimestamp();
    }

    // Initialize the dashboard
    function initDashboard() {
        initDistributionChart();
        refreshData();
        
        // Set up auto-refresh (every 30 seconds)
        setInterval(refreshData, 30000);
        
        // Set up manual refresh button
        refreshBtn.addEventListener('click', function() {
            refreshData();
            
            // Add rotation animation to refresh icon
            const refreshIcon = this.querySelector('i');
            refreshIcon.classList.add('fa-spin');
            setTimeout(() => {
                refreshIcon.classList.remove('fa-spin');
            }, 1000);
        });
    }

    // Initialize when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', initDashboard);
</script>
{% endblock %}